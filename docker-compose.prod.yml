services:
    postgres:
        image: postgres:15-alpine
        container_name: intelink-postgres-prod
        restart: unless-stopped
        ports:
            - '5432:5432'
        environment:
            - POSTGRES_USER=intelink
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-intelink}
            - POSTGRES_DB=IntelinkDB
            - POSTGRES_INITDB_ARGS="--encoding=UTF8 --locale=C"
        networks:
            - intelink-network
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U intelink -d IntelinkDB']
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 30s

    app:
        container_name: intelink-app-prod
        build:
            context: ./intelink-project
            dockerfile: Dockerfile.prod
        restart: unless-stopped
        ports:
            - '8080:8080'
        environment:
            - SPRING_PROFILES_ACTIVE=prod
            - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/IntelinkDB
            - SPRING_DATASOURCE_USERNAME=intelink
            - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:-intelink}
            - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
            - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect
            - JWT_SECRET=${JWT_SECRET:-myVerySecretKeyThatIsAtLeast256BitsLongForHS256Algorithm}
            - FRONTEND_URL=${FRONTEND_URL:-https://intelink.app}
            - BACKEND_URL=${BACKEND_URL:-https://api.intelink.app}
            - MAXMIND_LICENSE_KEY=${MAXMIND_LICENSE_KEY}
            - SAFE_BROWSING_API_KEY=${SAFE_BROWSING_API_KEY}
            - GEOLITE2_UPDATE_ENABLED=${GEOLITE2_UPDATE_ENABLED:-true}
            - GEOLITE2_UPDATE_SCHEDULE=${GEOLITE2_UPDATE_SCHEDULE:-0 0 2 * * TUE}
            - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - intelink-network
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8080/actuator/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

networks:
    intelink-network:
        driver: bridge

volumes:
    postgres_data:
        driver: local